<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon CONNECT | Model Visualizer</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        window.mermaid = mermaid;
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: false, htmlLabels: true, curve: 'basis' }
        });
    </script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap"
        rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Space Grotesk', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        background: '#0a0a0b',
                        surface: '#1a1a1d',
                        surface2: '#252529',
                        primary: '#6366f1',
                        border: '#2a2a2f',
                        thought: '#FF00FF',
                        search: '#00FFFF',
                        code: '#FF0000'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --theme-system-online: #00FF00;
            --theme-thought: #FF00FF;
            --theme-search: #00FFFF;
            --theme-code-execution: #FF0000;
        }

        body {
            background-color: #0a0a0b;
            color: #fafafa;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .tab-btn.active {
            border-bottom: 2px solid #6366f1;
            color: #6366f1;
        }

        .plot-container {
            min-height: 350px;
            width: 100%;
        }

        .mermaid-wrapper {
            width: 100%;
            overflow-x: auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            min-height: 400px;
            display: flex;
            align-items: center;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        input[type="range"] {
            accent-color: #6366f1;
        }

        .token-item {
            display: inline-block;
            padding: 2px 8px;
            margin: 2px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            background: rgba(0, 255, 0, 0.05);
            /* Neon Green Tint */
            border: 1px solid rgba(0, 255, 0, 0.2);
            color: #00ff00;
            /* Neon Green Text */
        }

        .token-item:hover {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.3);
        }

        .prompt-text {
            color: #00ff00;
            /* Neon Green */
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
        }

        /* Green for prompt */
        .gen-text {
            color: #ffffff;
            /* Bright White */
        }

        /* Default for generation */

        /* Legacy Switch Button */
        #legacy-switch-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(26, 26, 29, 0.8);
            border: 1px solid #2a2a2f;
            padding: 8px 16px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: #71717a;
            transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        #legacy-switch-btn:hover {
            color: #fff;
            border-color: #6366f1;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.2);
            transform: translateY(-2px);
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden font-sans text-sm md:text-base">
    <!-- Legacy Switch Button -->
    <a href="/neoncore" id="legacy-switch-btn">Switch to Legacy Chat</a>

    <!-- Header -->
    <header
        class="h-16 border-b border-border flex items-center justify-between px-6 bg-surface/50 backdrop-blur-md z-20 shrink-0">
        <div class="flex items-center gap-3">
            <img src="{{ url_for('static', filename='logo.png') }}" class="w-8 h-8 rounded-lg shadow-lg">
            <h1 class="text-xl font-bold font-display tracking-tight">
                <span class="text-code">N</span><span class="text-thought">e</span><span
                    class="text-primary">o</span><span class="text-search">n</span> <span
                    class="text-gray-400">CONNECT</span>
            </h1>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-xs font-mono text-gray-500">{{ username }}</span>
            <a href="/logout"
                class="text-xs font-bold text-red-500/80 hover:text-red-400 uppercase tracking-wider">Logout</a>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden">
        <!-- Sidebar -->
        <aside class="w-72 border-r border-border flex flex-col bg-surface/30 shrink-0 hidden lg:flex">
            <div class="p-4 border-b border-border">
                <label class="block text-[10px] font-bold uppercase text-gray-500 tracking-widest mb-2">Active
                    Network</label>
                <select id="model-select"
                    class="w-full bg-surface border border-border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary appearance-none cursor-pointer hover:bg-surface2 transition-colors">
                    <option value="">Loading...</option>
                </select>
            </div>
            <div id="model-info" class="p-4 flex-1 overflow-y-auto custom-scrollbar space-y-4 font-mono text-[10px]">
                <div class="animate-pulse space-y-3">
                    <div class="h-4 bg-surface2 rounded w-3/4"></div>
                    <div class="h-20 bg-surface2 rounded"></div>
                </div>
            </div>
        </aside>

        <!-- Main Workspace -->
        <div class="flex-1 flex flex-col overflow-hidden relative">
            <!-- Prompt Input -->
            <!-- Prompt Input -->
            <div class="p-4 border-b border-border bg-surface/10 backdrop-blur-sm shrink-0">
                <div class="w-full flex gap-3 px-4">
                    <div class="flex-1 relative">
                        <textarea id="prompt-input" rows="2" placeholder="Enter prompt to visualize..."
                            class="w-full bg-surface/50 border border-border rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all resize-none font-light custom-scrollbar">Harry looked at the mirror and saw</textarea>
                    </div>
                    <button id="visualize-btn"
                        class="px-8 py-2 bg-primary hover:bg-primary/80 text-white rounded-xl font-bold transition-all shadow-lg shadow-primary/20 disabled:opacity-50 shrink-0">
                        Analyze
                    </button>
                </div>
                <!-- Tokenization Display (Moved here) -->
                <div id="token-display"
                    class="hidden w-full mx-auto mt-4 px-4 py-3 bg-green-500/10 border border-green-500/30 rounded-xl">
                    <h3 class="text-[10px] font-bold uppercase text-[#00ff00] tracking-widest mb-2 font-mono">
                        Tokenization</h3>
                    <div id="token-list" class="flex flex-wrap gap-1"></div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-border bg-surface/5 px-4 overflow-x-auto no-scrollbar shrink-0">
                <button
                    class="tab-btn px-5 py-3 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all active whitespace-nowrap"
                    data-tab="architecture">Structure</button>
                <button
                    class="tab-btn px-5 py-3 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                    data-tab="single-head">Heads Detailed</button>
                <button
                    class="tab-btn px-5 py-3 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                    data-tab="all-heads">Grid</button>
                <button
                    class="tab-btn px-5 py-3 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                    data-tab="mlp-acts">MLP</button>
                <button
                    class="tab-btn px-5 py-3 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                    data-tab="next-token">Predictor</button>
                <button
                    class="tab-btn px-5 py-3 text-xs font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                    data-tab="inference">Live Chat</button>
            </div>

            <!-- Tab Content -->
            <div id="tab-content" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar relative">
                <div id="viz-container" class="max-w-6xl mx-auto space-y-6">


                    <div id="main-viz-content">
                        <div class="text-center py-32 text-gray-500">
                            <h2 class="text-lg font-bold text-gray-300 mb-2 uppercase tracking-tighter">Telemetric
                                Interface
                                Ready</h2>
                            <p class="text-sm text-gray-500">Initialize analyzer to capture tensor activations.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let currentModel = null;
        let lastVisData = null;
        let models = [];

        const modelSelect = document.getElementById('model-select');
        const modelInfo = document.getElementById('model-info');
        const promptInput = document.getElementById('prompt-input');
        const visualizeBtn = document.getElementById('visualize-btn');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const vizContainer = document.getElementById('viz-container');

        async function init() {
            try {
                const res = await fetch('/api/neonconnect/models');
                models = await res.json();
                modelSelect.innerHTML = models.map(m => `<option value="${m.id}">${m.label}</option>`).join('');
                if (models.length > 0) selectModel(models[0].id);
            } catch (e) {
                console.error("Init Error:", e);
            }
        }

        function selectModel(id) {
            currentModel = models.find(m => m.id === id);
            if (!currentModel) return;
            modelInfo.innerHTML = `
                <div class="space-y-4">
                    <p class="text-primary font-bold">NETWORK: ${currentModel.model_name}</p>
                    <div class="grid grid-cols-2 gap-2 text-gray-500 uppercase tracking-tighter">
                        <span>Weights</span><span class="text-right text-gray-300">${currentModel.data_name}</span>
                        <span>Tokenizer</span><span class="text-right text-gray-300">${currentModel.tok_name}</span>
                    </div>
                </div>
            `;
            if (currentModel.data_name.includes('wiki')) {
                promptInput.value = "Black holes typically form when massive stars collapse at the end of their life cycle. After a black hole has formed, it can grow by absorbing ";
            } else {
                promptInput.value = "Harry looked at the mirror and saw";
            }
            if (document.querySelector('.tab-btn.active').dataset.tab === 'architecture') renderArchitecture();
        }

        modelSelect.onchange = (e) => selectModel(e.target.value);

        tabBtns.forEach(btn => {
            btn.onclick = () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderTab(btn.dataset.tab);
            };
        });

        async function visualize() {
            if (!currentModel) return;
            visualizeBtn.disabled = true;
            visualizeBtn.textContent = "Capture...";
            vizContainer.innerHTML = `<div class="flex items-center justify-center py-32"><div class="w-12 h-12 border-4 border-primary border-t-transparent rounded-full animate-spin"></div></div>`;

            try {
                const res = await fetch('/api/neonconnect/visualize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: currentModel.id, prompt: promptInput.value })
                });
                if (!res.ok) throw new Error(`Status ${res.status}`);
                lastVisData = await res.json();

                // Populate Token Display
                const tokenList = document.getElementById('token-list');
                const tokenDisplay = document.getElementById('token-display');
                if (tokenList && lastVisData.tokens) {
                    tokenDisplay.classList.remove('hidden');
                    tokenList.innerHTML = lastVisData.tokens.map(t => `<span class="token-item">${cleanT(t)}</span>`).join('');
                }

                renderTab(document.querySelector('.tab-btn.active').dataset.tab);
            } catch (e) {
                vizContainer.innerHTML = `<div class="p-4 bg-red-500/10 border border-red-500/20 text-red-400 rounded-xl">Error: ${e.message}</div>`;
            } finally {
                visualizeBtn.disabled = false;
                visualizeBtn.textContent = "Analyze";
            }
        }

        visualizeBtn.onclick = visualize;

        function renderTab(tabId) {
            vizContainer.innerHTML = '';
            if (tabId === 'architecture') { renderArchitecture(); return; }
            if (!lastVisData) {
                vizContainer.innerHTML = `<div class="text-center py-20 text-gray-500"><p>No capture data available. Run Analyze.</p></div>`;
                return;
            }
            if (tabId === 'single-head') renderSingleHead();
            else if (tabId === 'all-heads') renderAllHeads();
            else if (tabId === 'mlp-acts') renderMLP();
            else if (tabId === 'next-token') renderNextToken();
            else if (tabId === 'inference') renderInference();
        }

        function cleanT(t) { return (t || "").replace('Ġ', '·').replace('Ċ', '↵').replace('▁', '·'); }
        function getTLabels(tokens) { return (tokens || []).map((t, i) => `${i}:${cleanT(t)}`); }

        function renderArchitecture() {
            const mermaidCode = `
graph LR
    A["Sequence"] --> B["Embedding"]
    B --> C["Residual Stream"]
    
    subgraph Block ["Transformer Block (x4)"]
        direction LR
        C --> LN1["RMSNorm"]
        
        subgraph Attn ["Conv-Attention"]
            direction LR
            LN1 --> PROJ["C_Attn Linear"]
            
            PROJ --> S1["Q Split"]
            PROJ --> S2["K Split"]
            PROJ --> S3["V Split"]
            PROJ --> S4["I Split"]
            
            S1 --> CQ["K3 DepthConv"]
            S2 --> CK["K3 DepthConv"]
            S3 --> CV["K3 DepthConv"]
            S4 --> CI["K3 DepthConv"]
            
            CQ --> ROPE1["ROPE"]
            CK --> ROPE2["ROPE"]
            
            ROPE1 --> DOT["Softmax(Q @ Kᵀ)"]
            ROPE2 --> DOT
            DOT --> WV["Attn @ V"]
            CV --> WV
            
            WV --> GATE["Intent Gating (⊙ σ(I))"]
            CI --> GATE
            
            GATE --> CPR["C_Proj Linear"]
        end
        
        CPR --> R1["(+) Add"]
        C --> R1
        
        R1 --> LN2["RMSNorm"]
        
        subgraph Hydra ["Hydra MLP"]
            direction LR
            LN2 --> HW1["Content W1"]
            LN2 --> HC9["K9 DepthConv"]
            HC9 --> HG["Gate Pattern"]
            HG --> HM["Hadamard (⊙ σ)"]
            HW1 --> HM
            HM --> HW2["W2 Linear"]
        end
        
        HW2 --> R2["(+) Add"]
        R1 --> R2
    end
    
    R2 --> F["Final Norm"]
    F --> H["Head"]
    H --> P["Probs"]
            `;
            vizContainer.innerHTML = `<div class="mermaid-wrapper"><div class="mermaid">${mermaidCode}</div></div>`;
            if (window.mermaid) window.mermaid.contentLoaded();
        }

        function renderSingleHead() {
            const config = lastVisData.config;
            vizContainer.innerHTML = `
                <div class="space-y-8 pb-12">
                    <div class="flex gap-4 items-end bg-surface/40 p-4 rounded-2xl border border-border">
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold uppercase text-gray-500 tracking-widest mb-1">Layer</label>
                            <select id="layer-sel" class="w-full bg-surface border border-border rounded-lg px-3 py-2 text-sm appearance-none outline-none">
                                ${Array.from({ length: config.n_layers }, (_, i) => `<option value="${i}">Layer ${i}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-[10px] font-bold uppercase text-gray-500 tracking-widest mb-1">Head</label>
                            <select id="head-sel" class="w-full bg-surface border border-border rounded-lg px-3 py-2 text-sm appearance-none outline-none">
                                ${Array.from({ length: config.n_head }, (_, i) => `<option value="${i}">Head ${i}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h4 class="text-[10px] font-bold uppercase tracking-widest text-primary">Attention Matrix</h4>
                            <div id="attn-plot" class="plot-container bg-surface/20 rounded-2xl border border-border overflow-hidden"></div>
                        </div>
                        
                        <div class="space-y-4">
                            <h4 class="text-[10px] font-bold uppercase tracking-widest text-search">Raw Core Projections (Linear)</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div id="q-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-48"></div>
                                <div id="k-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-48"></div>
                                <div id="v-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-48"></div>
                                <div id="i-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-48"></div>
                            </div>
                        </div>

                        <div class="xl:col-span-2 space-y-4 pt-8 border-t border-border">
                            <h4 class="text-[10px] font-bold uppercase tracking-widest text-code">Convolved Projections (DepthWise K=3)</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div id="conv-q-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                                <div id="conv-k-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                                <div id="conv-v-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                                <div id="conv-i-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                            </div>
                        </div>
                        
                        <div class="xl:col-span-2 space-y-4 pt-8 border-t border-border">
                             <h4 class="text-[10px] font-bold uppercase tracking-widest text-thought">Gating Vectors</h4>
                             <div id="intent-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-32"></div>
                        </div>
                    </div>
                </div>
            `;

            const update = () => {
                const l = parseInt(document.getElementById('layer-sel').value);
                const h = parseInt(document.getElementById('head-sel').value);
                plotSingleHeadDetailed(l, h);
            };
            document.getElementById('layer-sel').onchange = update;
            document.getElementById('head-sel').onchange = update;
            update();
        }

        function plotSingleHeadDetailed(layer, head) {
            const tokens = getTLabels(lastVisData.tokens);
            // Access new data structure: lastVisData.layers[layer][key]
            // Key is 'raw_q' [H, T, D] or 'attn' [B, H, T, T] -> [H, T, T] since we stripped B in backend sanitization for list
            // Wait, optimized_tensor_data recursive list conversion preserves structure.
            // Backend: attn is `w.detach().cpu()` -> [1, H, T, T].
            // Backend: raw_q is [H, T, D] (squeezed B=1? No, we viewed as [B, T, H, D] then [B, H, T, D]... wait.
            // In backend I did: `q = q.view(B, T, n_head, head_dim).transpose(1, 2)`. This is [B, H, T, D].
            // If B=1, then [0][H][T][D].
            // So we need to access [0][head].

            const layerData = lastVisData.layers[layer];

            const baseL = {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#71717a', size: 9, family: 'JetBrains Mono' },
                xaxis: { showticklabels: false, gridcolor: '#27272a' },
                yaxis: { autorange: 'reversed', showticklabels: false, gridcolor: '#27272a' },
                margin: { l: 10, r: 10, b: 10, t: 30 }, hovermode: 'closest'
            };

            const plotH = (id, z, title, colorscale = 'RdBu') => {
                if (!z) return;
                Plotly.newPlot(id, [{
                    z: z, x: Array.from({ length: z[0].length }, (_, i) => `d${i}`), y: tokens,
                    type: 'heatmap', colorscale: colorscale, zmid: 0, showscale: false
                }], { ...baseL, title: { text: title, font: { size: 9, weight: 'bold' } } }, { displayModeBar: false });
            };

            // Attention
            if (layerData.attn) {
                Plotly.newPlot('attn-plot', [{
                    z: layerData.attn[0][head], x: tokens, y: tokens, type: 'heatmap', colorscale: 'Blues', showscale: false
                }], { ...baseL, title: { text: 'ATTENTION WEIGHTS', font: { size: 9 } } }, { displayModeBar: false });
            }

            // Raw QKVI
            if (layerData.raw_q) plotH('q-plot', layerData.raw_q[0][head], 'RAW Q', 'RdBu');
            if (layerData.raw_k) plotH('k-plot', layerData.raw_k[0][head], 'RAW K', 'RdBu');
            if (layerData.raw_v) plotH('v-plot', layerData.raw_v[0][head], 'RAW V', 'RdBu');
            if (layerData.raw_i) plotH('i-plot', layerData.raw_i[0][head], 'RAW I', 'RdBu');

            // Conv QKVI
            if (layerData.conv_q) plotH('conv-q-plot', layerData.conv_q[0][head], 'CONV Q', 'RdBu');
            if (layerData.conv_k) plotH('conv-k-plot', layerData.conv_k[0][head], 'CONV K', 'RdBu');
            if (layerData.conv_v) plotH('conv-v-plot', layerData.conv_v[0][head], 'CONV V', 'RdBu');
            if (layerData.conv_i) plotH('conv-i-plot', layerData.conv_i[0][head], 'CONV I', 'Viridis');

            // MLP Gate (Single per block, maybe repeat for heads or just show once?)
            // MLP Gate captured as [B, T, D_ff]. Not per head.
            // Let's just visualize it if we have it?
            // "Adding gating vector is okayish".
            // It's [0][T][D].
            if (layerData.mlp_gate) {
                const z = layerData.mlp_gate[0]; // [T, D]
                Plotly.newPlot('intent-plot', [{
                    z: z, x: Array.from({ length: z[0].length }, (_, i) => `d${i}`), y: tokens,
                    type: 'heatmap', colorscale: 'Viridis', showscale: false
                }], { ...baseL, title: { text: 'MLP GATING VECTOR (σ)', font: { size: 9 } } }, { displayModeBar: false });
            }
        }

        function renderAllHeads() {
            const nl = lastVisData.config.n_layers;
            const nh = lastVisData.config.n_head;
            vizContainer.innerHTML = `
                <div class="flex flex-col gap-6 py-4 overflow-x-auto custom-scrollbar">
                    <div class="flex min-w-[800px]">
                        <div class="w-20 shrink-0"></div>
                        <div class="flex-1 grid gap-3" style="grid-template-columns: repeat(${nh}, minmax(0, 1fr));">
                            ${Array.from({ length: nh }, (_, i) => `<div class="text-center text-[10px] font-bold text-gray-500">HEAD ${i}</div>`).join('')}
                        </div>
                    </div>
                    ${Array.from({ length: nl }, (_, l) => `
                        <div class="flex items-stretch min-w-[800px]">
                            <div class="w-20 shrink-0 flex items-center justify-end text-[10px] font-bold text-gray-500 border-r border-border pr-4 mr-4">LAYER ${l}</div>
                            <div class="flex-1 grid gap-3" style="grid-template-columns: repeat(${nh}, minmax(0, 1fr));">
                                ${Array.from({ length: nh }, (_, h) => `<div id="grid-l${l}-h${h}" class="aspect-square bg-surface/20 border border-border rounded-xl"></div>`).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            // This is likely where the Head 0 issue was. 
            // 'repeat(${nh}, 1fr)' combined with Plotly auto-sizing might collapse empty divs or similar.
            // Using minmax(0, 1fr) helps.
            // Also ensuring the plots are rendered AFTER the DOM is settled.

            requestAnimationFrame(() => {
                for (let l = 0; l < nl; l++) {
                    const layerAttn = lastVisData.layers[l].attn;
                    if (!layerAttn) continue;
                    for (let h = 0; h < nh; h++) {
                        Plotly.newPlot(`grid-l${l}-h${h}`, [{
                            z: layerAttn[0][h], type: 'heatmap', colorscale: 'Blues', showscale: false
                        }], {
                            margin: { l: 0, r: 0, b: 0, t: 0 },
                            xaxis: { showticklabels: false, showgrid: false },
                            yaxis: { autorange: 'reversed', showticklabels: false, showgrid: false },
                            paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                        }, { staticPlot: true, responsive: true });
                    }
                }
            });
        }

        function renderMLP() {
            const nl = lastVisData.config.n_layers;
            vizContainer.innerHTML = `
                <div class="space-y-8 pb-12">
                    <div class="bg-surface/40 p-4 rounded-2xl border border-border max-w-xs">
                        <label class="block text-[10px] font-bold uppercase text-gray-500 mb-1">Block</label>
                        <select id="mlp-layer-sel" class="w-full bg-surface border border-border rounded-lg px-3 py-2 text-sm outline-none">
                            ${Array.from({ length: nl }, (_, i) => `<option value="${i}">Block ${i}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h4 class="text-[10px] font-bold uppercase text-primary tracking-widest">Inner Hidden States</h4>
                            <div id="mlp-act-plot" class="plot-container bg-surface/20 rounded-2xl border border-border h-[600px]"></div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="text-[10px] font-bold uppercase text-search tracking-widest">Hydra Gate Pattern</h4>
                            <div id="mlp-gate-plot" class="plot-container bg-surface/20 rounded-2xl border border-border h-[600px]"></div>
                        </div>
                    </div>
                </div>
            `;
            const update = () => plotMLPAct(parseInt(document.getElementById('mlp-layer-sel').value));
            document.getElementById('mlp-layer-sel').onchange = update;
            update();
        }

        function plotMLPAct(layer) {
            const tokens = getTLabels(lastVisData.tokens);
            // New structure: lastVisData.layers[layer].mlp = {input: ..., output: ...}
            if (!lastVisData.layers[layer].mlp) return;

            const data = lastVisData.layers[layer].mlp.input[0]; // [T, D_ff]?
            // backend: input: inp[0].detach().cpu() -> List. It was a Tensor [B, T, D] likely.
            // B=1 -> [0] -> [T, D]

            // Check dims. optimize_tensor_data converts tensor to list.
            // If tensor was [1, T, D_ff]. List is [1][T][D_ff].
            // So data[0] is [T, D_ff].

            const z = data[0].map((_, colIndex) => data.map(row => row[colIndex]));
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#71717a', size: 9, family: 'JetBrains Mono' },
                xaxis: { tickangle: 45, automargin: true, gridcolor: '#27272a' },
                yaxis: { automargin: true, showticklabels: false, gridcolor: '#27272a' },
                margin: { l: 50, r: 20, b: 50, t: 30 }
            };
            Plotly.newPlot('mlp-act-plot', [{
                z: z, x: tokens, y: Array.from({ length: z.length }, (_, i) => `d${i}`),
                type: 'heatmap', colorscale: 'RdBu', zmid: 0, showscale: false
            }], layout);
            if (lastVisData.layers[layer].mlp_gate) {
                const gateData = lastVisData.layers[layer].mlp_gate[0];
                Plotly.newPlot('mlp-gate-plot', [{
                    z: gateData, x: Array.from({ length: gateData[0].length }, (_, i) => `d${i}`), y: tokens,
                    type: 'heatmap', colorscale: 'Viridis', showscale: false
                }], { ...layout, yaxis: { ...layout.yaxis, autorange: 'reversed' } });
            }
        }

        function renderNextToken() {
            vizContainer.innerHTML = `<div class="bg-surface/20 rounded-2xl border border-border p-4 shadow-xl"><div id="probs-plot" class="plot-container" style="height: 600px;"></div></div>`;
            Plotly.newPlot('probs-plot', [{
                x: lastVisData.top_k_probs, y: lastVisData.top_k_tokens.map(t => `"${cleanT(t)}"`),
                type: 'bar', orientation: 'h', marker: { color: '#6366f1' }
            }], {
                title: { text: 'NEXT TOKEN PROBABILITIES', font: { size: 11, color: '#a1a1aa', weight: 'bold' } },
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#71717a', size: 10, family: 'JetBrains Mono' },
                xaxis: { gridcolor: '#27272a', title: 'Probability' }, yaxis: { autorange: 'reversed' },
                margin: { l: 150, r: 50, b: 50, t: 80 }
            });
        }

        function renderInference() {
            vizContainer.innerHTML = `
                <div class="max-w-2xl mx-auto space-y-6 py-6">
                    <div class="bg-[#111] p-8 rounded-3xl border border-white/5 shadow-2xl relative overflow-hidden">
                        <!-- New Gradient: Red -> Green -> Blue (Bright) -->
                        <div class="absolute top-0 left-0 right-0 h-1" style="background: linear-gradient(to right, #ff0000, #00ff00, #0000ff);"></div>
                        <h3 class="text-xl font-bold mb-6 flex items-center justify-between">
                            <div class="flex items-center gap-3"><span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span> Live Inference</div>
                            <button id="clear-console" class="text-[10px] font-bold text-gray-500 hover:text-red-400 uppercase tracking-widest">Clear</button>
                        </h3>
                        <div id="chat-output" class="min-h-[200px] bg-background/50 rounded-2xl p-6 mb-6 font-light whitespace-pre-wrap text-gray-300 border border-border/50 text-sm shadow-inner overflow-y-auto custom-scrollbar max-h-96">Ready...</div>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Temp</label><input id="temp-range" type="range" min="0.1" max="2.0" step="0.1" value="1.0" class="w-full"><div class="flex justify-between text-[10px] font-mono mt-1 text-gray-400"><span id="temp-val">1.0</span></div></div>
                            <div><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Tokens</label><input id="tokens-range" type="range" min="10" max="500" step="10" value="150" class="w-full"><div class="flex justify-between text-[10px] font-mono mt-1 text-gray-400"><span id="tokens-val">150</span></div></div>
                            <div><label class="block text-[10px] font-bold text-gray-500 mb-1 uppercase">Top K</label><input id="topk-range" type="range" min="1" max="100" step="1" value="50" class="w-full"><div class="flex justify-between text-[10px] font-mono mt-1 text-gray-400"><span id="topk-val">50</span></div></div>
                        </div>
                        <div class="flex gap-3">
                            <input id="chat-input" type="text" class="flex-1 bg-background border border-border rounded-xl px-5 py-3 text-sm outline-none focus:ring-2 focus:ring-primary/50" placeholder="Enter sequence start...">
                            <button id="chat-send" class="px-6 py-3 bg-primary hover:bg-primary/80 text-white rounded-xl font-bold transition-all shadow-lg shadow-primary/20">Generate</button>
                        </div>
                    </div>
                </div>
            `;
            const out = document.getElementById('chat-output');
            const inp = document.getElementById('chat-input');
            const send = document.getElementById('chat-send');
            const clear = document.getElementById('clear-console');
            const tr = document.getElementById('temp-range'); const tv = document.getElementById('temp-val'); tr.oninput = () => tv.textContent = tr.value;
            const lr = document.getElementById('tokens-range'); const lv = document.getElementById('tokens-val'); lr.oninput = () => lv.textContent = lr.value;
            const kr = document.getElementById('topk-range'); const kv = document.getElementById('topk-val'); kr.oninput = () => kv.textContent = kr.value;
            clear.onclick = () => out.innerHTML = "Ready..."; // innerHTML for color rendering
            send.onclick = async () => {
                const p = inp.value; if (!p) return;
                send.disabled = true; out.innerHTML = "Processing...";
                try {
                    const res = await fetch('/api/neonconnect/generate', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model_id: currentModel.id, prompt: p, max_tokens: parseInt(lr.value), temperature: parseFloat(tr.value), top_k: parseInt(kr.value) })
                    });
                    const data = await res.json();
                    if (data.prompt && data.completion) {
                        // Render with colors: Prompt Green, Completion Default
                        out.innerHTML = `<span class="prompt-text">${data.prompt}</span><span class="gen-text">${data.completion}</span>`;
                    } else if (data.result) {
                        // Fallback
                        out.textContent = data.result;
                    } else if (data.error) {
                        out.textContent = "Error: " + data.error;
                    }
                } catch (e) { out.textContent = "Error: " + e.message; }
                finally { send.disabled = false; }
            };
        }
        init();
    </script>
</body>

</html>