<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon CONNECT | Model Visualizer</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        window.mermaid = mermaid;
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: false, htmlLabels: true, curve: 'basis' }
        });
    </script>
    <link href="https://cdn.jsdelivr.net/fontsource/css/google-sans-flex@latest/index.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Google Sans Flex', 'Inter', 'system-ui', 'sans-serif'],
                        display: ['Google Sans Flex', 'Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        background: '#0a0a0b',
                        surface: '#1a1a1d',
                        surface2: '#252529',
                        primary: '#00ff66',
                        border: '#2a2a2f',
                        thought: '#FF00FF',
                        search: '#00FFFF',
                        code: '#FF0000'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --sidebar-width: 280px;
            --sidebar-collapsed: 56px;
            --transition-speed: 220ms;
            --primary: #00ff66;
            --primary-dim: rgba(0, 255, 102, 0.15);
            --primary-border: rgba(0, 255, 102, 0.3);
            --primary-glow: rgba(0, 255, 102, 0.4);
        }

        * {
            font-family: 'Google Sans Flex', 'Inter', system-ui, sans-serif;
        }

        code,
        pre,
        .font-mono {
            font-family: 'JetBrains Mono', monospace !important;
        }

        body {
            background: radial-gradient(ellipse at 50% 40%, #0a1a10 0%, #0a0a0b 70%);
            color: #fafafa;
            min-height: 100vh;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
                --sidebar-collapsed: 0px;
            }

            .sidebar {
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                background: #0a0a0b;
                z-index: 50;
            }

            .sidebar-toggle-mobile {
                display: flex !important;
            }

            #sidebar-toggle-btn {
                display: none;
            }
        }

        .sidebar-toggle-mobile {
            display: none;
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: #000;
            border-radius: 50%;
            z-index: 60;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 20px rgba(0, 255, 102, 0.4);
            border: none;
            cursor: pointer;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
            border-right-width: 0;
        }

        .sidebar.collapsed .sidebar-label,
        .sidebar.collapsed #model-select,
        .sidebar.collapsed #model-info,
        .sidebar.collapsed .sidebar-bottom-items {
            opacity: 0;
            pointer-events: none;
            overflow: hidden;
            white-space: nowrap;
        }

        .sidebar .sidebar-label,
        .sidebar #model-select,
        .sidebar #model-info,
        .sidebar .sidebar-bottom-items {
            transition: opacity var(--transition-speed) ease;
        }

        /* Tabs */
        .tab-btn {
            position: relative;
            transition: color 0.2s ease;
            font-size: 1rem;
        }

        .tab-btn.active {
            color: var(--primary);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 8px;
            right: 8px;
            height: 2px;
            background: var(--primary);
            box-shadow: 0 0 8px var(--primary-glow);
            border-radius: 2px;
        }

        .tab-content-fade {
            animation: fadeIn 300ms ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .plot-container {
            min-height: 350px;
            width: 100%;
        }

        .mermaid-wrapper {
            width: 100%;
            overflow-x: auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            min-height: 400px;
            display: flex;
            align-items: center;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        input[type="range"] {
            accent-color: var(--primary);
        }

        .token-item {
            display: inline-block;
            padding: 4px 12px;
            margin: 2px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.95rem;
            background: rgba(0, 255, 102, 0.05);
            border: 1px solid rgba(0, 255, 102, 0.2);
            color: #00ff66;
        }

        .token-item:hover {
            background: rgba(0, 255, 102, 0.2);
            border-color: #00ff66;
            box-shadow: 0 0 8px var(--primary-glow);
        }

        .prompt-text {
            color: #00ff66;
            text-shadow: 0 0 5px rgba(0, 255, 102, 0.3);
        }

        .gen-text {
            color: #ffffff;
        }

        .sidebar-toggle {
            width: 34px;
            height: 34px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #71717a;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .model-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 24px;
            border-radius: 999px;
            background: var(--primary-dim);
            border: 1px solid var(--primary-border);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: #88ffaa;
        }

        .landing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 65vh;
            padding: 2rem;
        }

        .landing-textarea {
            width: 100%;
            max-width: 740px;
            min-height: 170px;
            background: rgba(26, 26, 29, 0.6);
            border: 1px solid #2a2a2f;
            border-radius: 16px;
            padding: 24px;
            font-size: 1.15rem;
            line-height: 1.6;
            color: #fafafa;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .landing-textarea:focus {
            border-color: var(--primary-border);
            box-shadow: 0 0 0 4px rgba(0, 255, 102, 0.08);
        }

        .landing-textarea::placeholder {
            color: #52525b;
        }

        .action-btn {
            padding: 14px 38px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn-primary {
            background: var(--primary);
            color: #0a0a0b;
            font-weight: 700;
            box-shadow: 0 4px 20px rgba(0, 255, 102, 0.2);
        }

        .action-btn-primary:hover:not(:disabled) {
            background: #33ff88;
            transform: translateY(-1px);
            box-shadow: 0 6px 24px rgba(0, 255, 102, 0.3);
        }

        .action-btn-secondary {
            background: rgba(255, 255, 255, 0.06);
            color: #d4d4d8;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .loading-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 32px;
            margin-top: 24px;
        }

        .spinner {
            width: 44px;
            height: 44px;
            border: 3px solid rgba(0, 255, 102, 0.15);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typewriter-cursor::after {
            content: 'â–Š';
            color: var(--primary);
            animation: blink 0.8s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        /* RGB bar */
        .rgb-bar {
            height: 3px;
            background: linear-gradient(90deg, #ff0000, #ff8800, #ffff00, #00ff66, #0088ff, #0000ff, #8800ff, #ff0000);
            background-size: 200% 100%;
        }

        .rgb-bar-glow {
            box-shadow: 0 0 12px rgba(255, 0, 0, 0.3), 0 0 12px rgba(0, 255, 102, 0.3), 0 0 12px rgba(0, 0, 255, 0.3);
        }

        .rgb-bar-animate {
            animation: rgbSlide 2s linear infinite;
        }

        @keyframes rgbSlide {
            from {
                background-position: 0% 50%;
            }

            to {
                background-position: 200% 50%;
            }
        }

        .gen-dots span {
            animation: dotPulse 1.4s ease-in-out infinite;
            display: inline-block;
        }

        .gen-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .gen-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes dotPulse {

            0%,
            80%,
            100% {
                opacity: 0.3;
                transform: translateY(0);
            }

            40% {
                opacity: 1;
                transform: translateY(-4px);
            }
        }

        /* Section headers */
        .section-title {
            font-size: 0.95rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden text-base">

    <!-- Sidebar -->
    <button id="mobile-toggle" class="sidebar-toggle-mobile"
        onclick="setSidebarState(!sidebar.classList.contains('collapsed'))">â˜°</button>
    <aside id="sidebar"
        class="sidebar h-full border-r border-border flex flex-col bg-surface/40 backdrop-blur-sm shrink-0 z-30">
        <div class="flex items-center gap-3 p-4 border-b border-border sidebar-section" style="min-height: 56px;">
            <img src="{{ url_for('static', filename='logo.png') }}" class="w-8 h-8 rounded-lg shadow-lg shrink-0">
            <h1 class="text-xl font-bold tracking-tight sidebar-label whitespace-nowrap overflow-hidden">
                <span class="text-code">N</span><span class="text-thought">e</span><span
                    class="text-primary">o</span><span class="text-search">n</span>
                <span class="text-gray-400 text-sm">CONNECT</span>
            </h1>
            <button id="sidebar-toggle-btn" class="sidebar-toggle ml-auto" title="Toggle sidebar">Â«</button>
        </div>
        <div class="p-4 border-b border-border sidebar-section">
            <label class="block text-sm font-semibold uppercase text-gray-500 tracking-widest mb-2 sidebar-label">Active
                Network</label>
            <select id="model-select"
                class="w-full bg-surface border border-border rounded-lg px-3 py-3 text-base focus:outline-none focus:ring-1 focus:ring-primary appearance-none cursor-pointer hover:bg-surface2 transition-colors">
                <option value="">Loading...</option>
            </select>
        </div>
        <div id="model-info"
            class="p-4 flex-1 overflow-y-auto custom-scrollbar space-y-4 font-mono text-sm sidebar-section">
            <div class="animate-pulse space-y-3">
                <div class="h-4 bg-surface2 rounded w-3/4"></div>
                <div class="h-20 bg-surface2 rounded"></div>
            </div>
        </div>
        <div class="border-t border-border p-4 space-y-3 sidebar-section sidebar-bottom-items">
            <div class="flex items-center gap-2">
                <div
                    class="w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center text-sm font-bold text-primary shrink-0">
                    {{ username[0] | upper }}</div>
                <span class="text-base text-gray-400 truncate sidebar-label">{{ username }}</span>
            </div>
            <div class="flex gap-3">
                <a href="/neoncore"
                    class="text-sm font-semibold text-gray-500 hover:text-primary uppercase tracking-wider transition-colors sidebar-label">Legacy</a>
                <span class="text-gray-600 sidebar-label">Â·</span>
                <a href="/logout"
                    class="text-sm font-semibold text-red-500/70 hover:text-red-400 uppercase tracking-wider transition-colors sidebar-label">Logout</a>
            </div>
        </div>
    </aside>

    <!-- Main Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <div class="flex border-b border-border bg-surface/5 px-2 overflow-x-auto no-scrollbar shrink-0">
            <button
                class="tab-btn px-5 py-4 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all active whitespace-nowrap"
                data-tab="input">ğŸ¯ Input</button>
            <button
                class="tab-btn px-5 py-4 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="architecture">ğŸ—ï¸ Structure</button>
            <button
                class="tab-btn px-5 py-4 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="single-head">ğŸ§  Heads</button>
            <button
                class="tab-btn px-5 py-4 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="all-heads">ğŸ”² Grid</button>
            <button
                class="tab-btn px-5 py-4 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="mlp-acts">âš¡ MLP</button>
            <button
                class="tab-btn px-5 py-4 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="next-token">ğŸ“Š Predictor</button>
            <button
                class="tab-btn px-5 py-4 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="inference">ğŸ’¬ Live Chat</button>
        </div>
        <div id="tab-content" class="flex-1 overflow-y-auto custom-scrollbar relative">
            <div id="viz-container" class="w-full mx-auto"></div>
        </div>
    </div>

    <script>
        let currentModel = null;
        let lastVisData = null;
        let models = [];

        const modelSelect = document.getElementById('model-select');
        const modelInfo = document.getElementById('model-info');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const vizContainer = document.getElementById('viz-container');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle-btn');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setSidebarState(collapsed) {
            sidebar.classList.toggle('collapsed', collapsed);
            sidebarToggle.textContent = collapsed ? 'Â»' : 'Â«';
            localStorage.setItem('sidebar-collapsed', collapsed ? '1' : '0');
        }
        sidebarToggle.onclick = () => setSidebarState(!sidebar.classList.contains('collapsed'));
        if (localStorage.getItem('sidebar-collapsed') === '1') setSidebarState(true);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function getInitialPrompt(model) {
            if (!model) return "Harry looked at the mirror and saw";
            if (model.model_name === 'neon213') {
                return "The underlying purpose and ultimate meaning of life is";
            }
            return model.data_name.includes('wiki')
                ? "Black holes typically form when massive stars collapse at the end of their life cycle. After a black hole has formed, it can grow by absorbing "
                : "Harry looked at the mirror and saw";
        }

        async function init() {
            try {
                const res = await fetch('/api/neonconnect/models');
                models = await res.json();
                modelSelect.innerHTML = models.map(m => `<option value="${m.id}">${m.label}</option>`).join('');

                // Set neon213 k21 as default if exists
                const k21 = models.find(m => m.model_name === 'neon213' && m.id.includes('fp16'));
                if (k21) {
                    modelSelect.value = k21.id;
                    selectModel(k21.id);
                } else if (models.length > 0) {
                    selectModel(models[0].id);
                }
            } catch (e) { console.error("Init Error:", e); }
            renderTab('input');
        }

        function selectModel(id) {
            currentModel = models.find(m => m.id === id);
            if (!currentModel) return;
            modelInfo.innerHTML = `
                <div class="space-y-4">
                    <p class="text-primary font-bold text-base">NETWORK: ${currentModel.model_name}</p>
                    <div class="grid grid-cols-2 gap-2 text-gray-500 uppercase tracking-tighter text-sm">
                        <span>Weights</span><span class="text-right text-gray-300">${currentModel.data_name}</span>
                        <span>Tokenizer</span><span class="text-right text-gray-300">${currentModel.tok_name}</span>
                    </div>
                </div>`;
            const promptEl = document.getElementById('prompt-input');
            if (promptEl) {
                promptEl.value = getInitialPrompt(currentModel);
            }
            updateModelBadge();
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab && activeTab.dataset.tab === 'architecture') renderArchitecture();
        }

        function updateModelBadge() {
            const badge = document.getElementById('model-badge');
            if (badge && currentModel) badge.textContent = `${currentModel.model_name} Â· ${currentModel.data_name}`;
        }
        modelSelect.onchange = (e) => selectModel(e.target.value);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        tabBtns.forEach(btn => {
            btn.onclick = () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderTab(btn.dataset.tab);
            };
        });
        function switchToTab(tabId) {
            tabBtns.forEach(b => b.classList.remove('active'));
            const target = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (target) target.classList.add('active');
            renderTab(tabId);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ANALYZE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function doAnalyze() {
            if (!currentModel) return;
            const promptEl = document.getElementById('prompt-input');
            const analyzeBtn = document.getElementById('analyze-btn');
            const generateBtn = document.getElementById('generate-btn');
            if (!promptEl || !analyzeBtn) return;

            analyzeBtn.disabled = true;
            if (generateBtn) generateBtn.disabled = true;
            analyzeBtn.textContent = "Analyzing...";

            let loadingEl = document.getElementById('input-loading');
            if (!loadingEl) {
                loadingEl = document.createElement('div');
                loadingEl.id = 'input-loading';
                loadingEl.className = 'loading-overlay';
                const landing = document.querySelector('.landing-container');
                if (landing) landing.appendChild(loadingEl);
            }
            loadingEl.innerHTML = '<div class="spinner"></div><span class="text-base text-gray-400">Capturing tensor activations...</span>';
            loadingEl.style.display = 'flex';

            const tokenDisplay = document.getElementById('token-display');
            if (tokenDisplay) tokenDisplay.classList.add('hidden');

            try {
                const res = await fetch('/api/neonconnect/visualize', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: currentModel.id, prompt: promptEl.value })
                });
                if (!res.ok) throw new Error(`Status ${res.status}`);
                lastVisData = await res.json();

                if (tokenDisplay && lastVisData.tokens) {
                    tokenDisplay.classList.remove('hidden');
                    const tokenList = document.getElementById('token-list');
                    if (tokenList) tokenList.innerHTML = lastVisData.tokens.map(t => `<span class="token-item">${cleanT(t)}</span>`).join('');
                }
                if (loadingEl) loadingEl.style.display = 'none';
                await new Promise(r => setTimeout(r, 500));
                switchToTab('architecture');
            } catch (e) {
                if (loadingEl) loadingEl.innerHTML = `<div class="text-red-400 text-base">Error: ${e.message}</div>`;
            } finally {
                analyzeBtn.disabled = false;
                if (generateBtn) generateBtn.disabled = false;
                analyzeBtn.textContent = "ğŸ” Analyze";
            }
        }

        async function doGenerate() {
            if (!currentModel) return;
            const promptEl = document.getElementById('prompt-input');
            const generateBtn = document.getElementById('generate-btn');
            if (!promptEl || !generateBtn) return;
            generateBtn.disabled = true;
            generateBtn.textContent = "Starting...";
            switchToTab('inference');
            await new Promise(r => setTimeout(r, 50));
            const inp = document.getElementById('chat-input');
            if (inp) inp.value = promptEl.value;
            const send = document.getElementById('chat-send');
            if (send) send.click();
            generateBtn.disabled = false;
            generateBtn.textContent = "ğŸ’¬ Generate";
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TAB RENDERER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderTab(tabId) {
            if (tabId !== 'input') vizContainer.innerHTML = '';
            vizContainer.className = 'w-full mx-auto tab-content-fade';

            if (tabId === 'input') return renderInput();
            if (tabId === 'architecture') return renderArchitecture();
            if (!lastVisData && tabId !== 'inference') {
                vizContainer.innerHTML = `<div class="text-center py-20 text-gray-500"><p class="text-lg">No capture data. Go to Input tab and run Analyze.</p></div>`;
                return;
            }
            if (tabId === 'single-head') renderSingleHead();
            else if (tabId === 'all-heads') renderAllHeads();
            else if (tabId === 'mlp-acts') renderMLP();
            else if (tabId === 'next-token') renderNextToken();
            else if (tabId === 'inference') renderInference();
        }

        function cleanT(t) { return (t || "").replace('Ä ', 'Â·').replace('ÄŠ', 'â†µ').replace('â–', 'Â·'); }
        function getTLabels(tokens) { return (tokens || []).map((t, i) => `${i}:${cleanT(t)}`); }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INPUT TAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderInput() {
            const defaultPrompt = getInitialPrompt(currentModel);
            const modelLabel = currentModel ? `${currentModel.model_name} Â· ${currentModel.data_name}` : 'No model loaded';

            vizContainer.innerHTML = `
                <div class="landing-container">
                    <div id="model-badge" class="model-badge mb-8">${modelLabel}</div>
                    <textarea id="prompt-input" rows="5" placeholder="Enter your prompt..."
                        class="landing-textarea custom-scrollbar">${defaultPrompt}</textarea>
                    <div class="flex gap-5 mt-8">
                        <button id="analyze-btn" class="action-btn action-btn-primary" onclick="doAnalyze()">ğŸ” Analyze</button>
                        <button id="generate-btn" class="action-btn action-btn-secondary" onclick="doGenerate()">ğŸ’¬ Generate</button>
                    </div>
                    <div id="token-display" class="hidden w-full max-w-[740px] mt-6 px-5 py-4 bg-primary/5 border border-primary/20 rounded-xl">
                        <h3 class="text-sm font-bold uppercase text-primary tracking-widest mb-2 font-mono">Tokenization</h3>
                        <div id="token-list" class="flex flex-wrap gap-1"></div>
                    </div>
                </div>`;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ARCHITECTURE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderArchitecture() {
            const currentModelId = modelSelect.value || "";
            let attnGateLabel = "Intent Gating (âŠ™ Ïƒ(I))";
            let mlpGateLabel = "Hadamard (âŠ™ Ïƒ)";
            if (currentModelId.includes("neon185") || currentModelId.includes("neon213")) mlpGateLabel = "Hadamard (âŠ™ SiLU)";

            const mermaidCode = `
graph LR
    linkStyle default interpolate linear
    A["Sequence"] --> B["Embedding"]
    B --> C["Residual Stream"]
    subgraph Block ["Transformer Block (x4)"]
        direction LR
        C --> LN1["RMSNorm"]
        subgraph Attn ["Conv-Attention"]
            direction LR
            LN1 --> PROJ["C_Attn Linear"]
            PROJ -- Q --> S1["Q Split"]
            PROJ -- K --> S2["K Split"]
            PROJ -- V --> S3["V Split"]
            PROJ -- I --> S4["I Split"]
            S1 --> CQ["K3 DepthConv"]
            S2 --> CK["K3 DepthConv"]
            S3 --> CV["K3 DepthConv"]
            S4 --> CI["K3 DepthConv"]
            CQ --> ROPE1["RoPE"]
            CK --> ROPE2["RoPE"]
            ROPE1 --> DOT["Softmax(Q @ Káµ€ / âˆšd)"]
            ROPE2 --> DOT
            DOT --> WV["Attn @ V"]
            CV --> WV
            WV --> GATE["${attnGateLabel}"]
            CI --> GATE
            GATE --> CPR["C_Proj Linear"]
        end
        CPR --> R1["(+) Add"]
        C --> R1
        R1 --> LN2["RMSNorm"]
        subgraph Hydra ["Hydra MLP"]
            direction LR
            LN2 --> HW1["Content W1"]
            LN2 --> HC9["K9 DepthConv"]
            HC9 --> HG["Gate Pattern"]
            HG --> HM["${mlpGateLabel}"]
            HW1 --> HM
            HM --> HW2["W2 Linear"]
        end
        HW2 --> R2["(+) Add"]
        R1 --> R2
    end
    R2 --> F["Final Norm"]
    F --> H["Head"]
    H --> P["Probs"]`;

            let tokenHtml = '';
            if (lastVisData && lastVisData.tokens) {
                tokenHtml = `<div class="mt-6 px-5 py-4 bg-primary/5 border border-primary/20 rounded-xl">
                    <h3 class="text-sm font-bold uppercase text-primary tracking-widest mb-2 font-mono">Tokenization</h3>
                    <div class="flex flex-wrap gap-1">${lastVisData.tokens.map(t => `<span class="token-item">${cleanT(t)}</span>`).join('')}</div></div>`;
            }
            vizContainer.innerHTML = `<div class="p-6 md:p-10 space-y-6">${tokenHtml}<div class="mermaid-wrapper"><div class="mermaid">${mermaidCode}</div></div></div>`;
            if (window.mermaid) window.mermaid.contentLoaded();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADS DETAILED â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderSingleHead() {
            const config = lastVisData.config;
            vizContainer.innerHTML = `
                <div class="space-y-10 pb-12 p-6 md:p-10">
                    <div class="flex gap-4 items-end bg-surface/40 p-5 rounded-2xl border border-border max-w-lg">
                        <div class="flex-1">
                            <label class="block text-sm font-semibold uppercase text-gray-500 tracking-widest mb-1">Layer</label>
                            <select id="layer-sel" class="w-full bg-surface border border-border rounded-lg px-4 py-3 text-base appearance-none outline-none">
                                ${Array.from({ length: config.n_layers }, (_, i) => `<option value="${i}">Layer ${i + 1}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-sm font-semibold uppercase text-gray-500 tracking-widest mb-1">Head</label>
                            <select id="head-sel" class="w-full bg-surface border border-border rounded-lg px-4 py-3 text-base appearance-none outline-none">
                                ${Array.from({ length: config.n_head }, (_, i) => `<option value="${i}">Head ${i + 1}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <!-- Raw Projections (1x4) -->
                    <div class="space-y-4">
                        <h4 class="section-title text-search">Raw Core Projections (Linear)</h4>
                        <div class="grid grid-cols-4 gap-4">
                            <div id="q-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                            <div id="k-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                            <div id="v-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                            <div id="i-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                        </div>
                    </div>

                    <!-- Convolved Projections (1x4) -->
                    <div class="space-y-4 pt-6 border-t border-border">
                        <h4 class="section-title text-code">Convolved Projections (DepthWise K=3)</h4>
                        <div class="grid grid-cols-4 gap-4">
                            <div id="conv-q-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-72"></div>
                            <div id="conv-k-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-72"></div>
                            <div id="conv-v-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-72"></div>
                            <div id="conv-i-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-72"></div>
                        </div>
                    </div>

                    <!-- Attention Matrix -->
                    <div class="space-y-4 pt-6 border-t border-border">
                        <h4 class="section-title text-primary">Attention Matrix</h4>
                        <div id="attn-plot" class="plot-container bg-surface/20 rounded-2xl border border-border overflow-hidden" style="height: 550px;"></div>
                    </div>
                </div>`;

            const update = () => {
                plotSingleHeadDetailed(parseInt(document.getElementById('layer-sel').value), parseInt(document.getElementById('head-sel').value));
            };
            document.getElementById('layer-sel').onchange = update;
            document.getElementById('head-sel').onchange = update;
            update();
        }

        function plotSingleHeadDetailed(layer, head) {
            const tokens = getTLabels(lastVisData.tokens);
            const layerData = lastVisData.layers[layer];
            const baseL = {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#71717a', size: 10, family: 'JetBrains Mono' },
                xaxis: { showticklabels: false, gridcolor: '#27272a' },
                yaxis: { autorange: 'reversed', showticklabels: false, gridcolor: '#27272a' },
                margin: { l: 10, r: 10, b: 10, t: 35 }, hovermode: 'closest'
            };
            const plotH = (id, z, title) => {
                if (!z) return;
                Plotly.newPlot(id, [{ z, x: Array.from({ length: z[0].length }, (_, i) => `d${i}`), y: tokens, type: 'heatmap', colorscale: 'RdBu', zmid: 0, showscale: false }],
                    { ...baseL, title: { text: title, font: { size: 11, weight: 'bold' } } }, { displayModeBar: false, responsive: true });
            };

            if (layerData.raw_q) plotH('q-plot', layerData.raw_q[0][head], 'RAW Q');
            if (layerData.raw_k) plotH('k-plot', layerData.raw_k[0][head], 'RAW K');
            if (layerData.raw_v) plotH('v-plot', layerData.raw_v[0][head], 'RAW V');
            if (layerData.raw_i) plotH('i-plot', layerData.raw_i[0][head], 'RAW I');

            if (layerData.conv_q) plotH('conv-q-plot', layerData.conv_q[0][head], 'CONV Q');
            if (layerData.conv_k) plotH('conv-k-plot', layerData.conv_k[0][head], 'CONV K');
            if (layerData.conv_v) plotH('conv-v-plot', layerData.conv_v[0][head], 'CONV V');
            if (layerData.conv_i) plotH('conv-i-plot', layerData.conv_i[0][head], 'CONV I');

            if (layerData.attn) {
                Plotly.newPlot('attn-plot', [{ z: layerData.attn[0][head], x: tokens, y: tokens, type: 'heatmap', colorscale: 'Blues', showscale: false }],
                    {
                        ...baseL, title: { text: 'ATTENTION WEIGHTS', font: { size: 11 } }, margin: { l: 80, r: 20, b: 60, t: 40 },
                        xaxis: { ...baseL.xaxis, showticklabels: true, tickangle: 45 }, yaxis: { ...baseL.yaxis, showticklabels: true }
                    },
                    { displayModeBar: false, responsive: true });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GRID â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderAllHeads() {
            vizContainer.innerHTML = `
                <div class="p-6 md:p-10 space-y-6">
                    <div class="flex gap-4 items-center bg-surface/40 p-4 rounded-xl border border-border max-w-2xl">
                        <label class="text-sm font-bold text-gray-500 uppercase tracking-widest">Grid Type</label>
                        <select id="grid-type-sel" class="bg-surface border border-border rounded-lg px-4 py-2 text-sm outline-none focus:ring-1 focus:ring-primary">
                            <option value="attn">Attention Matrices</option>
                            <option value="raw_q">Raw Query (Q)</option>
                            <option value="raw_k">Raw Key (K)</option>
                            <option value="raw_v">Raw Value (V)</option>
                            <option value="raw_i">Raw Intent (I)</option>
                            <option value="conv_q">Conv Query (Q')</option>
                            <option value="conv_k">Conv Key (K')</option>
                            <option value="conv_v">Conv Value (V')</option>
                            <option value="conv_i">Conv Intent (I')</option>
                        </select>
                    </div>
                    <div id="grid-mount" class="flex flex-col gap-6 py-4 overflow-x-auto custom-scrollbar"></div>
                </div>`;

            const update = () => plotAllHeadsGrid(document.getElementById('grid-type-sel').value);
            document.getElementById('grid-type-sel').onchange = update;
            update();
        }

        function plotAllHeadsGrid(type) {
            const mount = document.getElementById('grid-mount');
            const nl = lastVisData.config.n_layers, nh = lastVisData.config.n_head;

            mount.innerHTML = `
                <div class="flex min-w-[800px]">
                    <div class="w-24 shrink-0"></div>
                    <div class="flex-1 grid gap-3" style="grid-template-columns: repeat(${nh}, minmax(0, 1fr));">
                        ${Array.from({ length: nh }, (_, i) => `<div class="text-center text-sm font-bold text-gray-500">Head ${i + 1}</div>`).join('')}
                    </div>
                </div>
                ${Array.from({ length: nl }, (_, l) => `
                    <div class="flex items-stretch min-w-[800px]">
                        <div class="w-24 shrink-0 flex items-center justify-end text-sm font-bold text-gray-500 border-r border-border pr-4 mr-4">Layer ${l + 1}</div>
                        <div class="flex-1 grid gap-3" style="grid-template-columns: repeat(${nh}, minmax(0, 1fr));">
                            ${Array.from({ length: nh }, (_, h) => `<div id="grid-l${l}-h${h}" class="aspect-square bg-surface/20 border border-border rounded-xl"></div>`).join('')}
                        </div>
                    </div>
                `).join('')}`;

            requestAnimationFrame(() => {
                for (let l = 0; l < nl; l++) {
                    const layer = lastVisData.layers[l];
                    const data = layer[type];
                    if (!data) continue;
                    for (let h = 0; h < nh; h++) {
                        const z = data[0][h];
                        const colorscale = (type === 'attn') ? 'Blues' : 'RdBu';
                        Plotly.newPlot(`grid-l${l}-h${h}`, [{ z, type: 'heatmap', colorscale, zmid: (type === 'attn' ? null : 0), showscale: false }],
                            {
                                margin: { l: 0, r: 0, b: 0, t: 0 }, xaxis: { showticklabels: false, showgrid: false }, yaxis: { autorange: 'reversed', showticklabels: false, showgrid: false },
                                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                            }, { staticPlot: true, responsive: true });
                    }
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MLP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderMLP() {
            const nl = lastVisData.config.n_layers;
            vizContainer.innerHTML = `
                <div class="space-y-8 pb-12 p-6 md:p-10">
                    <div class="bg-surface/40 p-5 rounded-2xl border border-border max-w-xs">
                        <label class="block text-sm font-semibold uppercase text-gray-500 mb-1">Block</label>
                        <select id="mlp-layer-sel" class="w-full bg-surface border border-border rounded-lg px-4 py-3 text-base outline-none">
                            ${Array.from({ length: nl }, (_, i) => `<option value="${i}">Block ${i + 1}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h4 class="section-title text-primary">Inner Hidden States</h4>
                            <div id="mlp-act-plot" class="plot-container bg-surface/20 rounded-2xl border border-border h-[600px]"></div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="section-title text-search">Hydra Gate Pattern</h4>
                            <div id="mlp-gate-plot" class="plot-container bg-surface/20 rounded-2xl border border-border h-[600px]"></div>
                        </div>
                    </div>
                </div>`;
            const update = () => plotMLPAct(parseInt(document.getElementById('mlp-layer-sel').value));
            document.getElementById('mlp-layer-sel').onchange = update;
            update();
        }

        function plotMLPAct(layer) {
            const tokens = getTLabels(lastVisData.tokens);
            if (!lastVisData.layers[layer].mlp) return;
            const data = lastVisData.layers[layer].mlp.input[0];
            const z = data[0].map((_, colIndex) => data.map(row => row[colIndex]));
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#71717a', size: 10, family: 'JetBrains Mono' },
                xaxis: { tickangle: 45, automargin: true, gridcolor: '#27272a' },
                yaxis: { automargin: true, showticklabels: false, gridcolor: '#27272a' },
                margin: { l: 50, r: 20, b: 50, t: 30 }
            };
            Plotly.newPlot('mlp-act-plot', [{ z, x: tokens, y: Array.from({ length: z.length }, (_, i) => `d${i}`), type: 'heatmap', colorscale: 'RdBu', zmid: 0, showscale: false }], layout);
            if (lastVisData.layers[layer].mlp_gate) {
                const gateData = lastVisData.layers[layer].mlp_gate[0];
                Plotly.newPlot('mlp-gate-plot', [{ z: gateData, x: Array.from({ length: gateData[0].length }, (_, i) => `d${i}`), y: tokens, type: 'heatmap', colorscale: 'Viridis', showscale: false }],
                    { ...layout, yaxis: { ...layout.yaxis, autorange: 'reversed' } });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PREDICTOR â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderNextToken() {
            vizContainer.innerHTML = `<div class="p-6 md:p-10"><div class="bg-surface/20 rounded-2xl border border-border p-4 shadow-xl"><div id="probs-plot" class="plot-container" style="height: 600px;"></div></div></div>`;
            Plotly.newPlot('probs-plot', [{
                x: lastVisData.top_k_probs, y: lastVisData.top_k_tokens.map(t => `"${cleanT(t)}"`),
                type: 'bar', orientation: 'h', marker: { color: '#00ff66' }
            }], {
                title: { text: 'NEXT TOKEN PROBABILITIES', font: { size: 14, color: '#a1a1aa', weight: 'bold' } },
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#71717a', size: 11, family: 'JetBrains Mono' },
                xaxis: { gridcolor: '#27272a', title: 'Probability' }, yaxis: { autorange: 'reversed' },
                margin: { l: 150, r: 50, b: 50, t: 80 }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LIVE CHAT â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderInference() {
            vizContainer.innerHTML = `
                <div class="max-w-3xl mx-auto space-y-6 py-6 p-6 md:p-10">
                    <div class="bg-[#111] p-8 rounded-3xl border border-white/5 shadow-2xl relative overflow-hidden">
                        <div id="rgb-bar" class="rgb-bar rgb-bar-glow absolute top-0 left-0 right-0"></div>
                        <h3 class="text-2xl font-bold mb-6 flex items-center justify-between mt-2">
                            <div class="flex items-center gap-3"><span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span> Live Inference</div>
                            <button id="clear-console" class="text-sm font-bold text-gray-500 hover:text-red-400 uppercase tracking-widest">Clear</button>
                        </h3>
                        <div id="chat-output" class="min-h-[220px] bg-background/50 rounded-2xl p-6 mb-6 whitespace-pre-wrap text-gray-300 border border-border/50 text-lg shadow-inner overflow-y-auto custom-scrollbar max-h-[400px]" style="line-height:1.7;">Ready...</div>
                        <div class="grid grid-cols-4 gap-4 mb-6">
                            <div><label class="block text-sm font-semibold text-gray-500 mb-1 uppercase">Temp</label><input id="temp-range" type="range" min="0.1" max="2.0" step="0.1" value="1.0" class="w-full"><div class="text-sm font-mono mt-1 text-gray-400"><span id="temp-val">1.0</span></div></div>
                            <div><label class="block text-sm font-semibold text-gray-500 mb-1 uppercase">Tokens</label><input id="tokens-range" type="range" min="10" max="500" step="10" value="150" class="w-full"><div class="text-sm font-mono mt-1 text-gray-400"><span id="tokens-val">150</span></div></div>
                            <div><label class="block text-sm font-semibold text-gray-500 mb-1 uppercase">Top K</label><input id="topk-range" type="range" min="1" max="100" step="1" value="50" class="w-full"><div class="text-sm font-mono mt-1 text-gray-400"><span id="topk-val">50</span></div></div>
                            <div class="flex flex-col"><label class="block text-sm font-semibold text-gray-500 mb-1 uppercase">Correction</label>
                                <label class="relative inline-flex items-center cursor-pointer mt-1">
                                    <input id="core-toggle" type="checkbox" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"></div>
                                    <span class="ml-2 text-xs font-bold text-gray-500 uppercase">Beta</span>
                                </label>
                            </div>
                        </div>
                        <div class="flex gap-3">
                            <input id="chat-input" type="text" class="flex-1 bg-background border border-border rounded-xl px-5 py-4 text-lg outline-none focus:ring-2 focus:ring-primary/50" placeholder="Enter sequence start...">
                            <button id="chat-send" class="px-8 py-4 bg-primary hover:brightness-110 text-background rounded-xl font-bold text-lg transition-all shadow-lg shadow-primary/20">Generate</button>
                        </div>
                    </div>
                </div>`;

            const out = document.getElementById('chat-output');
            const inp = document.getElementById('chat-input');
            const send = document.getElementById('chat-send');
            const clear = document.getElementById('clear-console');
            const rgbBar = document.getElementById('rgb-bar');
            const tr = document.getElementById('temp-range'); const tv = document.getElementById('temp-val'); tr.oninput = () => tv.textContent = tr.value;
            const lr = document.getElementById('tokens-range'); const lv = document.getElementById('tokens-val'); lr.oninput = () => lv.textContent = lr.value;
            const kr = document.getElementById('topk-range'); const kv = document.getElementById('topk-val'); kr.oninput = () => kv.textContent = kr.value;
            clear.onclick = () => { out.innerHTML = "Ready..."; rgbBar.classList.remove('rgb-bar-animate'); };

            send.onclick = async () => {
                const p = inp.value; if (!p) return;
                send.disabled = true;
                rgbBar.classList.add('rgb-bar-animate');
                out.innerHTML = '<span class="text-gray-500 text-lg">Generating<span class="gen-dots"><span>.</span><span>.</span><span>.</span></span></span>';

                try {
                    const useCorrection = document.getElementById('core-toggle').checked;
                    const res = await fetch('/api/neonconnect/generate', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model_id: currentModel.id,
                            prompt: p,
                            max_tokens: parseInt(lr.value),
                            temperature: parseFloat(tr.value),
                            top_k: parseInt(kr.value),
                            use_correction: useCorrection
                        })
                    });
                    const data = await res.json();
                    if (data.prompt && data.completion) {
                        out.innerHTML = `<span class="prompt-text">${data.prompt}</span><span id="stream-target" class="gen-text typewriter-cursor"></span>`;
                        const target = document.getElementById('stream-target');
                        const rawTokens = data.completion.split(/(\s+)/).filter(x => x !== "");
                        let i = 0;
                        const speed = Math.max(20, Math.min(60, 4000 / rawTokens.length));
                        function typeNextToken() {
                            if (i < rawTokens.length) {
                                target.textContent += rawTokens[i];
                                i++;
                                out.scrollTop = out.scrollHeight;
                                setTimeout(typeNextToken, speed);
                            } else {
                                target.classList.remove('typewriter-cursor');
                                rgbBar.classList.remove('rgb-bar-animate');
                            }
                        }
                        typeNextToken();
                    } else if (data.result) {
                        out.textContent = data.result;
                        rgbBar.classList.remove('rgb-bar-animate');
                    } else if (data.error) {
                        out.textContent = "Error: " + data.error;
                        rgbBar.classList.remove('rgb-bar-animate');
                    }
                } catch (e) {
                    out.textContent = "Error: " + e.message;
                    rgbBar.classList.remove('rgb-bar-animate');
                } finally { send.disabled = false; }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        init();
    </script>
</body>

</html>