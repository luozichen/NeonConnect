<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon CONNECT | Model Visualizer</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        window.mermaid = mermaid;
        mermaid.initialize({
            startOnLoad: true,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: { useMaxWidth: false, htmlLabels: true, curve: 'basis' }
        });
    </script>
    <!-- Google Sans Flex via Fontsource CDN -->
    <link href="https://cdn.jsdelivr.net/fontsource/css/google-sans-flex@latest/index.css" rel="stylesheet">
    <!-- JetBrains Mono for monospace -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Google Sans Flex', 'Inter', 'system-ui', 'sans-serif'],
                        display: ['Google Sans Flex', 'Inter', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        background: '#0a0a0b',
                        surface: '#1a1a1d',
                        surface2: '#252529',
                        primary: '#6366f1',
                        border: '#2a2a2f',
                        thought: '#FF00FF',
                        search: '#00FFFF',
                        code: '#FF0000'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --sidebar-width: 280px;
            --sidebar-collapsed: 56px;
            --transition-speed: 220ms;
        }

        * {
            font-family: 'Google Sans Flex', 'Inter', system-ui, sans-serif;
        }

        code,
        pre,
        .font-mono {
            font-family: 'JetBrains Mono', monospace !important;
        }

        body {
            background: radial-gradient(ellipse at 50% 40%, #12121a 0%, #0a0a0b 70%);
            color: #fafafa;
            min-height: 100vh;
        }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            transition: width var(--transition-speed) ease;
            will-change: width;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }

        .sidebar.collapsed .sidebar-label {
            opacity: 0;
            pointer-events: none;
            width: 0;
            overflow: hidden;
        }

        .sidebar.collapsed .sidebar-section {
            padding-left: 14px;
            padding-right: 14px;
        }

        .sidebar.collapsed #model-select {
            opacity: 0;
            height: 0;
            margin: 0;
            padding: 0;
            border: 0;
            overflow: hidden;
        }

        .sidebar.collapsed #model-info {
            opacity: 0;
            height: 0;
            overflow: hidden;
        }

        .sidebar.collapsed .sidebar-bottom-items {
            opacity: 0;
            pointer-events: none;
        }

        .sidebar .sidebar-label,
        .sidebar #model-select,
        .sidebar #model-info,
        .sidebar .sidebar-bottom-items {
            transition: opacity var(--transition-speed) ease;
        }

        /* Tabs */
        .tab-btn {
            position: relative;
            transition: color 0.2s ease;
            font-size: 0.8rem;
        }

        .tab-btn.active {
            color: #6366f1;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 8px;
            right: 8px;
            height: 2px;
            background: #6366f1;
            box-shadow: 0 0 8px rgba(99, 102, 241, 0.4);
            border-radius: 2px;
        }

        /* Tab content fade-in */
        .tab-content-fade {
            animation: fadeIn 300ms ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(6px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Plots */
        .plot-container {
            min-height: 350px;
            width: 100%;
        }

        .mermaid-wrapper {
            width: 100%;
            overflow-x: auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            min-height: 400px;
            display: flex;
            align-items: center;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        input[type="range"] {
            accent-color: #6366f1;
        }

        /* Tokens */
        .token-item {
            display: inline-block;
            padding: 3px 10px;
            margin: 2px;
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            background: rgba(0, 255, 0, 0.05);
            border: 1px solid rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        .token-item:hover {
            background: rgba(0, 255, 0, 0.2);
            border-color: #00ff00;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.3);
        }

        .prompt-text {
            color: #00ff00;
            text-shadow: 0 0 5px rgba(0, 255, 0, 0.3);
        }

        .gen-text {
            color: #ffffff;
        }

        /* Toggle button */
        .sidebar-toggle {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #71717a;
            transition: all 0.15s ease;
            flex-shrink: 0;
        }

        .sidebar-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        /* Model badge */
        .model-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 20px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.25);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
            color: #a5b4fc;
        }

        /* Input landing */
        .landing-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 65vh;
            padding: 2rem;
        }

        .landing-textarea {
            width: 100%;
            max-width: 700px;
            min-height: 140px;
            background: rgba(26, 26, 29, 0.6);
            border: 1px solid #2a2a2f;
            border-radius: 16px;
            padding: 24px;
            font-size: 1.05rem;
            line-height: 1.6;
            color: #fafafa;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .landing-textarea:focus {
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .landing-textarea::placeholder {
            color: #52525b;
        }

        .action-btn {
            padding: 12px 32px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-btn-primary {
            background: #6366f1;
            color: white;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.25);
        }

        .action-btn-primary:hover:not(:disabled) {
            background: #5558e6;
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.35);
        }

        .action-btn-secondary {
            background: rgba(255, 255, 255, 0.06);
            color: #d4d4d8;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .action-btn-secondary:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        /* Loading spinner for input tab */
        .loading-overlay {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 32px;
            margin-top: 24px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Typewriter cursor */
        .typewriter-cursor::after {
            content: 'â–Š';
            color: #6366f1;
            animation: blink 0.8s step-end infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden text-base">

    <!-- Sidebar -->
    <aside id="sidebar"
        class="sidebar h-full border-r border-border flex flex-col bg-surface/40 backdrop-blur-sm shrink-0 z-30">
        <!-- Top: Logo + Toggle -->
        <div class="flex items-center gap-3 p-4 border-b border-border sidebar-section" style="min-height: 56px;">
            <img src="{{ url_for('static', filename='logo.png') }}" class="w-8 h-8 rounded-lg shadow-lg shrink-0">
            <h1 class="text-lg font-bold tracking-tight sidebar-label whitespace-nowrap overflow-hidden">
                <span class="text-code">N</span><span class="text-thought">e</span><span
                    class="text-primary">o</span><span class="text-search">n</span>
                <span class="text-gray-400 text-sm">CONNECT</span>
            </h1>
            <button id="sidebar-toggle-btn" class="sidebar-toggle ml-auto" title="Toggle sidebar">Â«</button>
        </div>

        <!-- Model Selector -->
        <div class="p-4 border-b border-border sidebar-section">
            <label class="block text-xs font-semibold uppercase text-gray-500 tracking-widest mb-2 sidebar-label">Active
                Network</label>
            <select id="model-select"
                class="w-full bg-surface border border-border rounded-lg px-3 py-2.5 text-sm focus:outline-none focus:ring-1 focus:ring-primary appearance-none cursor-pointer hover:bg-surface2 transition-colors">
                <option value="">Loading...</option>
            </select>
        </div>

        <!-- Model Info -->
        <div id="model-info"
            class="p-4 flex-1 overflow-y-auto custom-scrollbar space-y-4 font-mono text-xs sidebar-section">
            <div class="animate-pulse space-y-3">
                <div class="h-4 bg-surface2 rounded w-3/4"></div>
                <div class="h-20 bg-surface2 rounded"></div>
            </div>
        </div>

        <!-- Bottom: User Info -->
        <div class="border-t border-border p-4 space-y-3 sidebar-section sidebar-bottom-items">
            <div class="flex items-center gap-2">
                <div
                    class="w-7 h-7 rounded-full bg-primary/20 flex items-center justify-center text-xs font-bold text-primary shrink-0">
                    {{ username[0] | upper }}
                </div>
                <span class="text-sm text-gray-400 truncate sidebar-label">{{ username }}</span>
            </div>
            <div class="flex gap-3">
                <a href="/neoncore"
                    class="text-xs font-semibold text-gray-500 hover:text-primary uppercase tracking-wider transition-colors sidebar-label">Legacy</a>
                <span class="text-gray-600 sidebar-label">Â·</span>
                <a href="/logout"
                    class="text-xs font-semibold text-red-500/70 hover:text-red-400 uppercase tracking-wider transition-colors sidebar-label">Logout</a>
            </div>
        </div>
    </aside>

    <!-- Main Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Tabs -->
        <div class="flex border-b border-border bg-surface/5 px-2 overflow-x-auto no-scrollbar shrink-0">
            <button
                class="tab-btn px-5 py-3.5 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all active whitespace-nowrap"
                data-tab="input">ğŸ¯ Input</button>
            <button
                class="tab-btn px-5 py-3.5 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="architecture">ğŸ—ï¸ Structure</button>
            <button
                class="tab-btn px-5 py-3.5 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="single-head">ğŸ§  Heads</button>
            <button
                class="tab-btn px-5 py-3.5 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="all-heads">ğŸ”² Grid</button>
            <button
                class="tab-btn px-5 py-3.5 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="mlp-acts">âš¡ MLP</button>
            <button
                class="tab-btn px-5 py-3.5 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="next-token">ğŸ“Š Predictor</button>
            <button
                class="tab-btn px-5 py-3.5 font-bold uppercase tracking-widest text-gray-500 hover:text-white transition-all whitespace-nowrap"
                data-tab="inference">ğŸ’¬ Live Chat</button>
        </div>

        <!-- Tab Content -->
        <div id="tab-content" class="flex-1 overflow-y-auto custom-scrollbar relative">
            <div id="viz-container" class="max-w-6xl mx-auto"></div>
        </div>
    </div>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let currentModel = null;
        let lastVisData = null;
        let models = [];

        const modelSelect = document.getElementById('model-select');
        const modelInfo = document.getElementById('model-info');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const vizContainer = document.getElementById('viz-container');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle-btn');

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  SIDEBAR COLLAPSE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setSidebarState(collapsed) {
            if (collapsed) {
                sidebar.classList.add('collapsed');
                sidebarToggle.textContent = 'Â»';
            } else {
                sidebar.classList.remove('collapsed');
                sidebarToggle.textContent = 'Â«';
            }
            localStorage.setItem('sidebar-collapsed', collapsed ? '1' : '0');
        }
        sidebarToggle.onclick = () => setSidebarState(!sidebar.classList.contains('collapsed'));
        if (localStorage.getItem('sidebar-collapsed') === '1') setSidebarState(true);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  INIT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function init() {
            try {
                const res = await fetch('/api/neonconnect/models');
                models = await res.json();
                modelSelect.innerHTML = models.map(m => `<option value="${m.id}">${m.label}</option>`).join('');
                if (models.length > 0) selectModel(models[0].id);
            } catch (e) {
                console.error("Init Error:", e);
            }
            renderTab('input');
        }

        function selectModel(id) {
            currentModel = models.find(m => m.id === id);
            if (!currentModel) return;
            modelInfo.innerHTML = `
                <div class="space-y-4">
                    <p class="text-primary font-bold text-sm">NETWORK: ${currentModel.model_name}</p>
                    <div class="grid grid-cols-2 gap-2 text-gray-500 uppercase tracking-tighter text-xs">
                        <span>Weights</span><span class="text-right text-gray-300">${currentModel.data_name}</span>
                        <span>Tokenizer</span><span class="text-right text-gray-300">${currentModel.tok_name}</span>
                    </div>
                </div>
            `;
            const promptEl = document.getElementById('prompt-input');
            if (promptEl) {
                if (currentModel.data_name.includes('wiki')) {
                    promptEl.value = "Black holes typically form when massive stars collapse at the end of their life cycle. After a black hole has formed, it can grow by absorbing ";
                } else {
                    promptEl.value = "Harry looked at the mirror and saw";
                }
            }
            updateModelBadge();
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab && activeTab.dataset.tab === 'architecture') renderArchitecture();
        }

        function updateModelBadge() {
            const badge = document.getElementById('model-badge');
            if (badge && currentModel) badge.textContent = `${currentModel.model_name} Â· ${currentModel.data_name}`;
        }

        modelSelect.onchange = (e) => selectModel(e.target.value);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  TABS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        tabBtns.forEach(btn => {
            btn.onclick = () => {
                tabBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderTab(btn.dataset.tab);
            };
        });

        function switchToTab(tabId) {
            tabBtns.forEach(b => b.classList.remove('active'));
            const target = document.querySelector(`.tab-btn[data-tab="${tabId}"]`);
            if (target) target.classList.add('active');
            renderTab(tabId);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  ANALYZE (stays on input, then transitions)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        async function doAnalyze() {
            if (!currentModel) return;
            const promptEl = document.getElementById('prompt-input');
            const analyzeBtn = document.getElementById('analyze-btn');
            const generateBtn = document.getElementById('generate-btn');
            if (!promptEl || !analyzeBtn) return;
            const prompt = promptEl.value;

            analyzeBtn.disabled = true;
            if (generateBtn) generateBtn.disabled = true;
            analyzeBtn.textContent = "Analyzing...";

            // Show loading spinner on the input tab itself
            let loadingEl = document.getElementById('input-loading');
            if (!loadingEl) {
                loadingEl = document.createElement('div');
                loadingEl.id = 'input-loading';
                loadingEl.className = 'loading-overlay';
                loadingEl.innerHTML = '<div class="spinner"></div><span class="text-sm text-gray-400">Capturing tensor activations...</span>';
                const landing = document.querySelector('.landing-container');
                if (landing) landing.appendChild(loadingEl);
            }
            loadingEl.style.display = 'flex';

            // Hide token display during loading
            const tokenDisplay = document.getElementById('token-display');
            if (tokenDisplay) tokenDisplay.classList.add('hidden');

            try {
                const res = await fetch('/api/neonconnect/visualize', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model_id: currentModel.id, prompt: prompt })
                });
                if (!res.ok) throw new Error(`Status ${res.status}`);
                lastVisData = await res.json();

                // Show tokenization on input tab briefly before switching
                if (tokenDisplay && lastVisData.tokens) {
                    tokenDisplay.classList.remove('hidden');
                    const tokenList = document.getElementById('token-list');
                    if (tokenList) tokenList.innerHTML = lastVisData.tokens.map(t => `<span class="token-item">${cleanT(t)}</span>`).join('');
                }

                // Brief pause to show tokens, then switch
                await new Promise(r => setTimeout(r, 400));
                switchToTab('architecture');
            } catch (e) {
                if (loadingEl) loadingEl.innerHTML = `<div class="text-red-400 text-sm">Error: ${e.message}</div>`;
            } finally {
                analyzeBtn.disabled = false;
                if (generateBtn) generateBtn.disabled = false;
                analyzeBtn.textContent = "ğŸ” Analyze";
            }
        }

        async function doGenerate() {
            if (!currentModel) return;
            const promptEl = document.getElementById('prompt-input');
            const generateBtn = document.getElementById('generate-btn');
            if (!promptEl || !generateBtn) return;
            const prompt = promptEl.value;

            generateBtn.disabled = true;
            generateBtn.textContent = "Starting...";

            // Switch to Live Chat immediately
            switchToTab('inference');
            await new Promise(r => setTimeout(r, 50));

            // Fill prompt and trigger
            const inp = document.getElementById('chat-input');
            if (inp) inp.value = prompt;
            const send = document.getElementById('chat-send');
            if (send) send.click();

            generateBtn.disabled = false;
            generateBtn.textContent = "ğŸ’¬ Generate";
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  TAB RENDERER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderTab(tabId) {
            if (tabId !== 'input') vizContainer.innerHTML = '';
            vizContainer.className = 'max-w-6xl mx-auto tab-content-fade';

            if (tabId === 'input') { renderInput(); return; }
            if (tabId === 'architecture') { renderArchitecture(); return; }
            if (!lastVisData && tabId !== 'inference') {
                vizContainer.innerHTML = `<div class="text-center py-20 text-gray-500"><p class="text-base">No capture data available. Go to Input tab and run Analyze.</p></div>`;
                return;
            }
            if (tabId === 'single-head') renderSingleHead();
            else if (tabId === 'all-heads') renderAllHeads();
            else if (tabId === 'mlp-acts') renderMLP();
            else if (tabId === 'next-token') renderNextToken();
            else if (tabId === 'inference') renderInference();
        }

        function cleanT(t) { return (t || "").replace('Ä ', 'Â·').replace('ÄŠ', 'â†µ').replace('â–', 'Â·'); }
        function getTLabels(tokens) { return (tokens || []).map((t, i) => `${i}:${cleanT(t)}`); }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  INPUT TAB (Landing Page)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderInput() {
            const defaultPrompt = currentModel
                ? (currentModel.data_name.includes('wiki')
                    ? "Black holes typically form when massive stars collapse at the end of their life cycle. After a black hole has formed, it can grow by absorbing "
                    : "Harry looked at the mirror and saw")
                : "Harry looked at the mirror and saw";

            const modelLabel = currentModel ? `${currentModel.model_name} Â· ${currentModel.data_name}` : 'No model loaded';

            vizContainer.innerHTML = `
                <div class="landing-container">
                    <div id="model-badge" class="model-badge mb-8">${modelLabel}</div>

                    <textarea id="prompt-input" rows="5" placeholder="Enter your prompt..."
                        class="landing-textarea custom-scrollbar">${defaultPrompt}</textarea>

                    <div class="flex gap-5 mt-8">
                        <button id="analyze-btn" class="action-btn action-btn-primary" onclick="doAnalyze()">ğŸ” Analyze</button>
                        <button id="generate-btn" class="action-btn action-btn-secondary" onclick="doGenerate()">ğŸ’¬ Generate</button>
                    </div>

                    <!-- Tokenization Display -->
                    <div id="token-display" class="hidden w-full max-w-[700px] mt-6 px-5 py-4 bg-green-500/10 border border-green-500/30 rounded-xl">
                        <h3 class="text-xs font-bold uppercase text-[#00ff00] tracking-widest mb-2 font-mono">Tokenization</h3>
                        <div id="token-list" class="flex flex-wrap gap-1"></div>
                    </div>
                </div>
            `;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  ARCHITECTURE TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderArchitecture() {
            const currentModelId = modelSelect.value || "";
            let attnGateLabel = "Intent Gating (âŠ™ Ïƒ(I))";
            let mlpGateLabel = "Hadamard (âŠ™ Ïƒ)";
            if (currentModelId.includes("neon185")) mlpGateLabel = "Hadamard (âŠ™ SiLU)";

            const mermaidCode = `
graph LR
    linkStyle default interpolate linear
    A["Sequence"] --> B["Embedding"]
    B --> C["Residual Stream"]
    subgraph Block ["Transformer Block (x4)"]
        direction LR
        C --> LN1["RMSNorm"]
        subgraph Attn ["Conv-Attention"]
            direction LR
            LN1 --> PROJ["C_Attn Linear"]
            PROJ -- Q --> S1["Q Split"]
            PROJ -- K --> S2["K Split"]
            PROJ -- V --> S3["V Split"]
            PROJ -- I --> S4["I Split"]
            S1 --> CQ["K3 DepthConv"]
            S2 --> CK["K3 DepthConv"]
            S3 --> CV["K3 DepthConv"]
            S4 --> CI["K3 DepthConv"]
            CQ --> ROPE1["RoPE"]
            CK --> ROPE2["RoPE"]
            ROPE1 --> DOT["Softmax(Q @ Káµ€ / âˆšd)"]
            ROPE2 --> DOT
            DOT --> WV["Attn @ V"]
            CV --> WV
            WV --> GATE["${attnGateLabel}"]
            CI --> GATE
            GATE --> CPR["C_Proj Linear"]
        end
        CPR --> R1["(+) Add"]
        C --> R1
        R1 --> LN2["RMSNorm"]
        subgraph Hydra ["Hydra MLP"]
            direction LR
            LN2 --> HW1["Content W1"]
            LN2 --> HC9["K9 DepthConv"]
            HC9 --> HG["Gate Pattern"]
            HG --> HM["${mlpGateLabel}"]
            HW1 --> HM
            HM --> HW2["W2 Linear"]
        end
        HW2 --> R2["(+) Add"]
        R1 --> R2
    end
    R2 --> F["Final Norm"]
    F --> H["Head"]
    H --> P["Probs"]
            `;

            let tokenHtml = '';
            if (lastVisData && lastVisData.tokens) {
                tokenHtml = `
                    <div class="mt-6 px-5 py-4 bg-green-500/10 border border-green-500/30 rounded-xl">
                        <h3 class="text-xs font-bold uppercase text-[#00ff00] tracking-widest mb-2 font-mono">Tokenization</h3>
                        <div class="flex flex-wrap gap-1">${lastVisData.tokens.map(t => `<span class="token-item">${cleanT(t)}</span>`).join('')}</div>
                    </div>
                `;
            }

            vizContainer.innerHTML = `<div class="p-4 md:p-8 space-y-6">${tokenHtml}<div class="mermaid-wrapper"><div class="mermaid">${mermaidCode}</div></div></div>`;
            if (window.mermaid) window.mermaid.contentLoaded();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  HEADS DETAILED TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderSingleHead() {
            const config = lastVisData.config;
            vizContainer.innerHTML = `
                <div class="space-y-8 pb-12 p-4 md:p-8">
                    <div class="flex gap-4 items-end bg-surface/40 p-4 rounded-2xl border border-border">
                        <div class="flex-1">
                            <label class="block text-xs font-semibold uppercase text-gray-500 tracking-widest mb-1">Layer</label>
                            <select id="layer-sel" class="w-full bg-surface border border-border rounded-lg px-3 py-2.5 text-sm appearance-none outline-none">
                                ${Array.from({ length: config.n_layers }, (_, i) => `<option value="${i}">Layer ${i}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex-1">
                            <label class="block text-xs font-semibold uppercase text-gray-500 tracking-widest mb-1">Head</label>
                            <select id="head-sel" class="w-full bg-surface border border-border rounded-lg px-3 py-2.5 text-sm appearance-none outline-none">
                                ${Array.from({ length: config.n_head }, (_, i) => `<option value="${i}">Head ${i}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold uppercase tracking-widest text-primary">Attention Matrix</h4>
                            <div id="attn-plot" class="plot-container bg-surface/20 rounded-2xl border border-border overflow-hidden"></div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold uppercase tracking-widest text-search">Raw Core Projections (Linear)</h4>
                            <div class="grid grid-cols-2 gap-2">
                                <div id="q-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-48"></div>
                                <div id="k-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-48"></div>
                                <div id="v-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-48"></div>
                                <div id="i-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-48"></div>
                            </div>
                        </div>
                        <div class="xl:col-span-2 space-y-4 pt-8 border-t border-border">
                            <h4 class="text-xs font-bold uppercase tracking-widest text-code">Convolved Projections (DepthWise K=3)</h4>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div id="conv-q-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                                <div id="conv-k-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                                <div id="conv-v-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                                <div id="conv-i-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-64"></div>
                            </div>
                        </div>
                        <div class="xl:col-span-2 space-y-4 pt-8 border-t border-border">
                             <h4 class="text-xs font-bold uppercase tracking-widest text-thought">Gating Vectors</h4>
                             <div id="intent-plot" class="plot-container bg-surface/20 rounded-xl border border-border h-32"></div>
                        </div>
                    </div>
                </div>
            `;
            const update = () => {
                const l = parseInt(document.getElementById('layer-sel').value);
                const h = parseInt(document.getElementById('head-sel').value);
                plotSingleHeadDetailed(l, h);
            };
            document.getElementById('layer-sel').onchange = update;
            document.getElementById('head-sel').onchange = update;
            update();
        }

        function plotSingleHeadDetailed(layer, head) {
            const tokens = getTLabels(lastVisData.tokens);
            const layerData = lastVisData.layers[layer];
            const baseL = {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#71717a', size: 9, family: 'JetBrains Mono' },
                xaxis: { showticklabels: false, gridcolor: '#27272a' },
                yaxis: { autorange: 'reversed', showticklabels: false, gridcolor: '#27272a' },
                margin: { l: 10, r: 10, b: 10, t: 30 }, hovermode: 'closest'
            };
            const plotH = (id, z, title, colorscale = 'RdBu') => {
                if (!z) return;
                Plotly.newPlot(id, [{ z, x: Array.from({ length: z[0].length }, (_, i) => `d${i}`), y: tokens, type: 'heatmap', colorscale, zmid: 0, showscale: false }],
                    { ...baseL, title: { text: title, font: { size: 9, weight: 'bold' } } }, { displayModeBar: false });
            };
            if (layerData.attn) Plotly.newPlot('attn-plot', [{ z: layerData.attn[0][head], x: tokens, y: tokens, type: 'heatmap', colorscale: 'Blues', showscale: false }],
                { ...baseL, title: { text: 'ATTENTION WEIGHTS', font: { size: 9 } } }, { displayModeBar: false });
            if (layerData.raw_q) plotH('q-plot', layerData.raw_q[0][head], 'RAW Q');
            if (layerData.raw_k) plotH('k-plot', layerData.raw_k[0][head], 'RAW K');
            if (layerData.raw_v) plotH('v-plot', layerData.raw_v[0][head], 'RAW V');
            if (layerData.raw_i) plotH('i-plot', layerData.raw_i[0][head], 'RAW I');
            if (layerData.conv_q) plotH('conv-q-plot', layerData.conv_q[0][head], 'CONV Q');
            if (layerData.conv_k) plotH('conv-k-plot', layerData.conv_k[0][head], 'CONV K');
            if (layerData.conv_v) plotH('conv-v-plot', layerData.conv_v[0][head], 'CONV V');
            if (layerData.conv_i) plotH('conv-i-plot', layerData.conv_i[0][head], 'CONV I', 'Viridis');
            if (layerData.mlp_gate) {
                const z = layerData.mlp_gate[0];
                Plotly.newPlot('intent-plot', [{ z, x: Array.from({ length: z[0].length }, (_, i) => `d${i}`), y: tokens, type: 'heatmap', colorscale: 'Viridis', showscale: false }],
                    { ...baseL, title: { text: 'MLP GATING VECTOR (Ïƒ)', font: { size: 9 } } }, { displayModeBar: false });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  GRID TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderAllHeads() {
            const nl = lastVisData.config.n_layers, nh = lastVisData.config.n_head;
            vizContainer.innerHTML = `
                <div class="flex flex-col gap-6 py-4 overflow-x-auto custom-scrollbar p-4 md:p-8">
                    <div class="flex min-w-[800px]">
                        <div class="w-20 shrink-0"></div>
                        <div class="flex-1 grid gap-3" style="grid-template-columns: repeat(${nh}, minmax(0, 1fr));">
                            ${Array.from({ length: nh }, (_, i) => `<div class="text-center text-xs font-bold text-gray-500">HEAD ${i}</div>`).join('')}
                        </div>
                    </div>
                    ${Array.from({ length: nl }, (_, l) => `
                        <div class="flex items-stretch min-w-[800px]">
                            <div class="w-20 shrink-0 flex items-center justify-end text-xs font-bold text-gray-500 border-r border-border pr-4 mr-4">LAYER ${l}</div>
                            <div class="flex-1 grid gap-3" style="grid-template-columns: repeat(${nh}, minmax(0, 1fr));">
                                ${Array.from({ length: nh }, (_, h) => `<div id="grid-l${l}-h${h}" class="aspect-square bg-surface/20 border border-border rounded-xl"></div>`).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            requestAnimationFrame(() => {
                for (let l = 0; l < nl; l++) {
                    const layerAttn = lastVisData.layers[l].attn;
                    if (!layerAttn) continue;
                    for (let h = 0; h < nh; h++) {
                        Plotly.newPlot(`grid-l${l}-h${h}`, [{ z: layerAttn[0][h], type: 'heatmap', colorscale: 'Blues', showscale: false }],
                            {
                                margin: { l: 0, r: 0, b: 0, t: 0 }, xaxis: { showticklabels: false, showgrid: false }, yaxis: { autorange: 'reversed', showticklabels: false, showgrid: false },
                                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)'
                            }, { staticPlot: true, responsive: true });
                    }
                }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  MLP TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderMLP() {
            const nl = lastVisData.config.n_layers;
            vizContainer.innerHTML = `
                <div class="space-y-8 pb-12 p-4 md:p-8">
                    <div class="bg-surface/40 p-4 rounded-2xl border border-border max-w-xs">
                        <label class="block text-xs font-semibold uppercase text-gray-500 mb-1">Block</label>
                        <select id="mlp-layer-sel" class="w-full bg-surface border border-border rounded-lg px-3 py-2.5 text-sm outline-none">
                            ${Array.from({ length: nl }, (_, i) => `<option value="${i}">Block ${i}</option>`).join('')}
                        </select>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold uppercase text-primary tracking-widest">Inner Hidden States</h4>
                            <div id="mlp-act-plot" class="plot-container bg-surface/20 rounded-2xl border border-border h-[600px]"></div>
                        </div>
                        <div class="space-y-4">
                            <h4 class="text-xs font-bold uppercase text-search tracking-widest">Hydra Gate Pattern</h4>
                            <div id="mlp-gate-plot" class="plot-container bg-surface/20 rounded-2xl border border-border h-[600px]"></div>
                        </div>
                    </div>
                </div>
            `;
            const update = () => plotMLPAct(parseInt(document.getElementById('mlp-layer-sel').value));
            document.getElementById('mlp-layer-sel').onchange = update;
            update();
        }

        function plotMLPAct(layer) {
            const tokens = getTLabels(lastVisData.tokens);
            if (!lastVisData.layers[layer].mlp) return;
            const data = lastVisData.layers[layer].mlp.input[0];
            const z = data[0].map((_, colIndex) => data.map(row => row[colIndex]));
            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#71717a', size: 9, family: 'JetBrains Mono' },
                xaxis: { tickangle: 45, automargin: true, gridcolor: '#27272a' },
                yaxis: { automargin: true, showticklabels: false, gridcolor: '#27272a' },
                margin: { l: 50, r: 20, b: 50, t: 30 }
            };
            Plotly.newPlot('mlp-act-plot', [{ z, x: tokens, y: Array.from({ length: z.length }, (_, i) => `d${i}`), type: 'heatmap', colorscale: 'RdBu', zmid: 0, showscale: false }], layout);
            if (lastVisData.layers[layer].mlp_gate) {
                const gateData = lastVisData.layers[layer].mlp_gate[0];
                Plotly.newPlot('mlp-gate-plot', [{ z: gateData, x: Array.from({ length: gateData[0].length }, (_, i) => `d${i}`), y: tokens, type: 'heatmap', colorscale: 'Viridis', showscale: false }],
                    { ...layout, yaxis: { ...layout.yaxis, autorange: 'reversed' } });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  PREDICTOR TAB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderNextToken() {
            vizContainer.innerHTML = `<div class="p-4 md:p-8"><div class="bg-surface/20 rounded-2xl border border-border p-4 shadow-xl"><div id="probs-plot" class="plot-container" style="height: 600px;"></div></div></div>`;
            Plotly.newPlot('probs-plot', [{
                x: lastVisData.top_k_probs, y: lastVisData.top_k_tokens.map(t => `"${cleanT(t)}"`),
                type: 'bar', orientation: 'h', marker: { color: '#6366f1' }
            }], {
                title: { text: 'NEXT TOKEN PROBABILITIES', font: { size: 12, color: '#a1a1aa', weight: 'bold' } },
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#71717a', size: 10, family: 'JetBrains Mono' },
                xaxis: { gridcolor: '#27272a', title: 'Probability' }, yaxis: { autorange: 'reversed' },
                margin: { l: 150, r: 50, b: 50, t: 80 }
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  LIVE CHAT TAB (with simulated streaming)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderInference() {
            vizContainer.innerHTML = `
                <div class="max-w-2xl mx-auto space-y-6 py-6 p-4 md:p-8">
                    <div class="bg-[#111] p-8 rounded-3xl border border-white/5 shadow-2xl relative overflow-hidden">
                        <div class="absolute top-0 left-0 right-0 h-1" style="background: linear-gradient(to right, #ff0000, #00ff00, #0000ff);"></div>
                        <h3 class="text-xl font-bold mb-6 flex items-center justify-between">
                            <div class="flex items-center gap-3"><span class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></span> Live Inference</div>
                            <button id="clear-console" class="text-xs font-bold text-gray-500 hover:text-red-400 uppercase tracking-widest">Clear</button>
                        </h3>
                        <div id="chat-output" class="min-h-[200px] bg-background/50 rounded-2xl p-6 mb-6 font-light whitespace-pre-wrap text-gray-300 border border-border/50 text-base shadow-inner overflow-y-auto custom-scrollbar max-h-96">Ready...</div>
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div><label class="block text-xs font-semibold text-gray-500 mb-1 uppercase">Temp</label><input id="temp-range" type="range" min="0.1" max="2.0" step="0.1" value="1.0" class="w-full"><div class="text-xs font-mono mt-1 text-gray-400"><span id="temp-val">1.0</span></div></div>
                            <div><label class="block text-xs font-semibold text-gray-500 mb-1 uppercase">Tokens</label><input id="tokens-range" type="range" min="10" max="500" step="10" value="150" class="w-full"><div class="text-xs font-mono mt-1 text-gray-400"><span id="tokens-val">150</span></div></div>
                            <div><label class="block text-xs font-semibold text-gray-500 mb-1 uppercase">Top K</label><input id="topk-range" type="range" min="1" max="100" step="1" value="50" class="w-full"><div class="text-xs font-mono mt-1 text-gray-400"><span id="topk-val">50</span></div></div>
                        </div>
                        <div class="flex gap-3">
                            <input id="chat-input" type="text" class="flex-1 bg-background border border-border rounded-xl px-5 py-3.5 text-base outline-none focus:ring-2 focus:ring-primary/50" placeholder="Enter sequence start...">
                            <button id="chat-send" class="px-7 py-3.5 bg-primary hover:bg-primary/80 text-white rounded-xl font-bold text-base transition-all shadow-lg shadow-primary/20">Generate</button>
                        </div>
                    </div>
                </div>
            `;
            const out = document.getElementById('chat-output');
            const inp = document.getElementById('chat-input');
            const send = document.getElementById('chat-send');
            const clear = document.getElementById('clear-console');
            const tr = document.getElementById('temp-range'); const tv = document.getElementById('temp-val'); tr.oninput = () => tv.textContent = tr.value;
            const lr = document.getElementById('tokens-range'); const lv = document.getElementById('tokens-val'); lr.oninput = () => lv.textContent = lr.value;
            const kr = document.getElementById('topk-range'); const kv = document.getElementById('topk-val'); kr.oninput = () => kv.textContent = kr.value;
            clear.onclick = () => out.innerHTML = "Ready...";

            send.onclick = async () => {
                const p = inp.value; if (!p) return;
                send.disabled = true; out.innerHTML = '<span class="text-gray-500">Generating...</span>';
                try {
                    const res = await fetch('/api/neonconnect/generate', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ model_id: currentModel.id, prompt: p, max_tokens: parseInt(lr.value), temperature: parseFloat(tr.value), top_k: parseInt(kr.value) })
                    });
                    const data = await res.json();
                    if (data.prompt && data.completion) {
                        // Simulated streaming: show prompt immediately, then typewrite completion
                        out.innerHTML = `<span class="prompt-text">${data.prompt}</span><span id="stream-target" class="gen-text typewriter-cursor"></span>`;
                        const target = document.getElementById('stream-target');
                        const chars = data.completion;
                        let i = 0;
                        const speed = Math.max(8, Math.min(30, 3000 / chars.length)); // adaptive speed
                        function typeNext() {
                            if (i < chars.length) {
                                target.textContent += chars[i];
                                i++;
                                // Auto-scroll
                                out.scrollTop = out.scrollHeight;
                                setTimeout(typeNext, speed);
                            } else {
                                // Done - remove cursor
                                target.classList.remove('typewriter-cursor');
                            }
                        }
                        typeNext();
                    } else if (data.result) {
                        out.textContent = data.result;
                    } else if (data.error) {
                        out.textContent = "Error: " + data.error;
                    }
                } catch (e) { out.textContent = "Error: " + e.message; }
                finally { send.disabled = false; }
            };
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  BOOT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        init();
    </script>
</body>

</html>